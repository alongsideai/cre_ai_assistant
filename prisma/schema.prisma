// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Property {
  id           String   @id @default(cuid())
  name         String
  address      String
  type         String?  // RETAIL, OFFICE, INDUSTRIAL, MIXED_USE
  timeZone     String   @default("America/New_York")
  ownerEntity  String?
  assetManager String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  leases       Lease[]
  documents    Document[]
  spaces       Space[]
  workOrders   WorkOrder[]

  @@index([name])
}

model Lease {
  id          String    @id @default(cuid())
  propertyId  String
  tenantName  String
  suite       String?
  squareFeet  Int?
  baseRent    Float?    // Monthly base rent
  leaseStart  DateTime?
  leaseEnd    DateTime?
  status      String    @default("ACTIVE") // ACTIVE, EXPIRED, FUTURE, NOTICE_GIVEN
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  property    Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  documents   Document[]
  clauses     LeaseClause[]

  @@index([propertyId])
  @@index([tenantName])
  @@index([status])
  @@index([leaseEnd])
}

model MonthlyNOISnapshot {
  id        String   @id @default(cuid())
  month     DateTime // First day of month
  portfolio String   @default("DEFAULT")
  noi       Float
  revenue   Float?
  expenses  Float?
  createdAt DateTime @default(now())

  @@index([portfolio])
  @@index([month])
}

// New unified document models
// Note: Using String for enums and Json fields because SQLite doesn't support them natively

model Document {
  id         String   @id @default(cuid())
  type       String   // LEASE | AMENDMENT | COI | INVOICE | EMAIL | WORK_ORDER | ABSTRACT | RENT_ROLL | OTHER
  status     String   @default("UPLOADED") // UPLOADED | PROCESSING | EXTRACTED | FAILED

  filePath   String
  fileName   String
  mimeType   String?
  uploadedAt DateTime @default(now())

  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id])

  leaseId    String?
  lease      Lease?    @relation(fields: [leaseId], references: [id])

  extractedData String? // JSON string

  chunks     DocumentChunk[]

  @@index([type])
  @@index([status])
  @@index([leaseId])
  @@index([propertyId])
}

model DocumentChunk {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  chunkIndex Int
  content    String
  embedding  String   // JSON string array of floats
  metadata   String?  // JSON string

  @@index([documentId])
  @@index([documentId, chunkIndex])
}

// Maintenance Module Models

model Space {
  id          String     @id @default(cuid())
  property    Property   @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId  String
  spaceLabel  String     // "Suite 120", "Bay 4", "3rd Floor East Wing"
  floor       String?
  areaSqft    Int?
  useType     String?    // RETAIL, OFFICE, WAREHOUSE, etc.
  notes       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  occupiers   Occupier[]
  workOrders  WorkOrder[]

  @@index([propertyId])
  @@index([spaceLabel])
}

model Occupier {
  id                   String    @id @default(cuid())
  space                Space     @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  spaceId              String
  legalName            String
  brandName            String?
  primaryContactName   String?
  primaryContactEmail  String?
  primaryContactPhone  String?
  storeNumber          String?
  notes                String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  workOrders           WorkOrder[]

  @@index([spaceId])
  @@index([legalName])
  @@index([brandName])
}

model Vendor {
  id          String   @id @default(cuid())
  name        String
  trade       String   // ROOFING, HVAC, PLUMBING, ELECTRICAL, GENERAL_CONTRACTOR, etc.
  email       String?
  phone       String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workOrders  WorkOrder[] @relation("VendorWorkOrders")

  @@index([trade])
  @@index([name])
}

model WorkOrder {
  id                   String      @id @default(cuid())
  property             Property    @relation(fields: [propertyId], references: [id])
  propertyId           String
  space                Space?      @relation(fields: [spaceId], references: [id])
  spaceId              String?
  occupier             Occupier?   @relation(fields: [occupierId], references: [id])
  occupierId           String?
  vendor               Vendor?     @relation("VendorWorkOrders", fields: [assignedVendorId], references: [id])
  assignedVendorId     String?

  status               String      // NEW, ASSIGNED, IN_PROGRESS, COMPLETED, CANCELLED
  priority             String      // LOW, MEDIUM, HIGH, EMERGENCY
  issueCategory        String      // ROOFING, HVAC, PLUMBING, ELECTRICAL, LIFE_SAFETY, GENERAL, OTHER
  businessImpact       String?     // MINOR, MODERATE, MAJOR, CRITICAL
  summary              String
  description          String
  requiresOwnerApproval Boolean    @default(false)
  estimatedCost        Float?
  maxApprovedCost      Float?

  sourceEmailText      String?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  dueAt                DateTime?
  vendorConfirmedAt    DateTime?   // When vendor confirmed dispatch (for demo simulation)
  notes                String?

  messages             Message[]
  scheduledActions     ScheduledAction[]

  @@index([propertyId])
  @@index([spaceId])
  @@index([occupierId])
  @@index([status])
  @@index([priority])
}

model Message {
  id             String    @id @default(cuid())
  workOrder      WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  workOrderId    String

  recipientType  String    // OCCUPIER, VENDOR, INTERNAL
  channel        String    // EMAIL, NOTE
  subject        String
  body           String
  status         String    // DRAFT, SENT, CANCELLED
  createdAt      DateTime  @default(now())
  sentAt         DateTime?
  meta           String?   // JSON string (SQLite doesn't support Json natively)

  @@index([workOrderId])
  @@index([recipientType])
}

model ScheduledAction {
  id             String    @id @default(cuid())
  workOrder      WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  workOrderId    String

  actionType     String    // VENDOR_FOLLOWUP, OCCUPIER_CHECKIN, ESCALATION_INTERNAL
  status         String    // PENDING, EXECUTED, CANCELLED
  scheduledFor   DateTime
  payload        String    // JSON string (SQLite doesn't support Json natively)
  description    String
  createdAt      DateTime  @default(now())
  executedAt     DateTime?

  @@index([workOrderId])
  @@index([status])
  @@index([scheduledFor])
}

// Lease Clause RAG Model - for clause-level responsibility Q&A
model LeaseClause {
  id               String   @id @default(cuid())
  lease            Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  leaseId          String

  topic            String   // HVAC, ROOF, STRUCTURE, CAM, INSURANCE, INDEMNITY, PARKING, SIGNAGE, ACCESS, UTILITIES, GENERAL_MAINTENANCE, OTHER
  responsibleParty String   // LANDLORD, TENANT, SHARED, UNKNOWN
  sectionLabel     String?  // e.g. "Section 4.2 â€“ Maintenance & Repairs"
  text             String   // Full clause text or chunk
  embedding        String?  // JSON string array of floats for vector search
  pageNumber       Int?

  createdAt        DateTime @default(now())

  @@index([leaseId])
  @@index([topic])
  @@index([responsibleParty])
}
